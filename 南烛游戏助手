-- 南烛游戏助手 - Roblox脚本助手
local NanzhuHelper = {}

-- 存储最小化状态和窗口是否被永久关闭
NanzhuHelper.isMinimized = false
NanzhuHelper.isClosed = false
NanzhuHelper.isRotating = false
NanzhuHelper.rotationSpeed = 50
NanzhuHelper.isFastRotating = false
NanzhuHelper.fastRotationSpeed = 100

-- 星空按钮图标（Base64编码的简单星空图案）
local starIcon = "rbxassetid://123456789" -- 替换为实际的星空图标AssetId

-- 初始化UI
function NanzhuHelper:InitUI()
    if self.isClosed then return end
    
    -- 创建主界面
    self.ScreenGui = Instance.new("ScreenGui")
    self.ScreenGui.Name = "NanzhuHelper"
    self.ScreenGui.Parent = game:GetService("CoreGui")
    
    -- 主框架
    self.MainFrame = Instance.new("Frame")
    self.MainFrame.Name = "MainFrame"
    self.MainFrame.Size = UDim2.new(0, 400, 0, 500)
    self.MainFrame.Position = UDim2.new(0.5, -200, 0.5, -250) -- 屏幕中央
    self.MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    self.MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    self.MainFrame.BorderSizePixel = 0
    self.MainFrame.Parent = self.ScreenGui
    
    -- 标题栏（添加拖动功能）
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 50)
    titleBar.Position = UDim2.new(0, 0, 0, 0)
    titleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    titleBar.BorderSizePixel = 0
    titleBar.Parent = self.MainFrame
    
    -- 拖动功能实现
    local dragging = false
    local dragInput, dragStart, startPos

    local function update(input)
        local delta = input.Position - dragStart
        self.MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = self.MainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    titleBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
            dragInput = input
        end
    end)

    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
    
    -- 标题
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Text = "南烛游戏助手"
    title.Size = UDim2.new(1, -100, 1, 0)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundTransparency = 1
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 24
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = titleBar
    
    -- 最小化按钮
    local minimizeButton = Instance.new("TextButton")
    minimizeButton.Name = "MinimizeButton"
    minimizeButton.Text = "-"
    minimizeButton.Size = UDim2.new(0, 30, 0, 30)
    minimizeButton.Position = UDim2.new(1, -70, 0.5, -15)
    minimizeButton.AnchorPoint = Vector2.new(1, 0.5)
    minimizeButton.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    minimizeButton.Font = Enum.Font.GothamBold
    minimizeButton.TextSize = 20
    minimizeButton.Parent = titleBar
    
    -- 关闭按钮
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Text = "×"
    closeButton.Size = UDim2.new(0, 30, 0, 30)
    closeButton.Position = UDim2.new(1, -30, 0.5, -15)
    closeButton.AnchorPoint = Vector2.new(1, 0.5)
    closeButton.BackgroundColor3 = Color3.fromRGB(70, 50, 50)
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.Font = Enum.Font.GothamBold
    closeButton.TextSize = 20
    closeButton.Parent = titleBar
    
    -- 星空重新打开按钮
    self.ReopenButton = Instance.new("ImageButton")
    self.ReopenButton.Name = "ReopenButton"
    self.ReopenButton.Size = UDim2.new(0, 40, 0, 40)
    self.ReopenButton.Position = UDim2.new(1, -50, 0, 10)
    self.ReopenButton.AnchorPoint = Vector2.new(1, 0)
    self.ReopenButton.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    self.ReopenButton.Image = starIcon
    self.ReopenButton.Visible = false
    self.ReopenButton.Parent = self.ScreenGui
    
    -- 加载提示
    local loading = Instance.new("TextLabel")
    loading.Name = "Loading"
    loading.Text = "欢迎使用南烛游戏助手\n脚本功能加载中..."
    loading.Size = UDim2.new(1, -40, 1, -60)
    loading.Position = UDim2.new(0, 20, 0, 60)
    loading.BackgroundTransparency = 1
    loading.TextColor3 = Color3.fromRGB(200, 200, 200)
    loading.Font = Enum.Font.Gotham
    loading.TextSize = 18
    loading.TextWrapped = true
    loading.Parent = self.MainFrame
    
    -- 按钮事件绑定
    minimizeButton.MouseButton1Click:Connect(function()
        self:ToggleMinimize()
    end)
    
    closeButton.MouseButton1Click:Connect(function()
        self:CloseWindow(true)
    end)
    
    self.ReopenButton.MouseButton1Click:Connect(function()
        self:RestoreWindow()
    end)
    
    -- 模拟加载
    wait(2)
    loading.Text = "欢迎使用南烛游戏助手\n脚本功能加载完毕！"
    wait(1)
    loading:Destroy()
    
    -- 创建功能界面
    self:CreateMainMenu()
end

-- 最小化/恢复窗口
function NanzhuHelper:ToggleMinimize()
    if self.isMinimized then
        self.MainFrame.Size = UDim2.new(0, 400, 0, 500)
        self.isMinimized = false
        self.ReopenButton.Visible = false
    else
        self.MainFrame.Size = UDim2.new(0, 0, 0, 0)
        self.isMinimized = true
        self.ReopenButton.Visible = true
        self:ShowNotification("窗口已最小化，点击星空图标恢复")
    end
end

-- 关闭窗口
function NanzhuHelper:CloseWindow(permanent)
    if permanent then
        self.isClosed = true
        self.ScreenGui:Destroy()
        self:ShowAdvancedNotification("窗口已关闭", "欢迎下次使用南烛游戏助手", 5)
    else
        self.ScreenGui:Destroy()
    end
end

-- 恢复窗口
function NanzhuHelper:RestoreWindow()
    if self.isClosed then return end
    
    if self.ScreenGui then
        self.ScreenGui:Destroy()
    end
    
    self.isMinimized = false
    self:InitUI()
end

-- 高级通知系统
function NanzhuHelper:ShowAdvancedNotification(title, message, duration)
    duration = duration or 3
    
    local notificationGui = Instance.new("ScreenGui")
    notificationGui.Name = "AdvancedNotification"
    notificationGui.Parent = game:GetService("CoreGui")
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 300, 0, 100)
    mainFrame.Position = UDim2.new(1, -320, 1, -120)
    mainFrame.AnchorPoint = Vector2.new(1, 1)
    mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = notificationGui
    
    -- 添加动画效果
    mainFrame.Position = UDim2.new(1, -320, 1, 100)
    mainFrame:TweenPosition(UDim2.new(1, -320, 1, -120), Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3)
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "Title"
    titleLabel.Text = title
    titleLabel.Size = UDim2.new(1, -20, 0, 30)
    titleLabel.Position = UDim2.new(0, 10, 0, 10)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 18
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = mainFrame
    
    local messageLabel = Instance.new("TextLabel")
    messageLabel.Name = "Message"
    messageLabel.Text = message
    messageLabel.Size = UDim2.new(1, -20, 1, -50)
    messageLabel.Position = UDim2.new(0, 10, 0, 40)
    messageLabel.BackgroundTransparency = 1
    messageLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    messageLabel.Font = Enum.Font.Gotham
    messageLabel.TextSize = 14
    messageLabel.TextWrapped = true
    messageLabel.TextXAlignment = Enum.TextXAlignment.Left
    messageLabel.Parent = mainFrame
    
    spawn(function()
        wait(duration)
        mainFrame:TweenPosition(UDim2.new(1, -320, 1, 100), Enum.EasingDirection.In, Enum.EasingStyle.Quad, 0.3, true, function()
            notificationGui:Destroy()
        end)
    end)
end

-- 显示通知（改进版）
function NanzhuHelper:ShowNotification(message)
    if not self.MainFrame then return end
    
    local notif = Instance.new("TextLabel")
    notif.Name = "Notification"
    notif.Text = message
    notif.Size = UDim2.new(1, -40, 0, 40)
    notif.Position = UDim2.new(0, 20, 1, -50)
    notif.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    notif.TextColor3 = Color3.fromRGB(255, 255, 255)
    notif.Font = Enum.Font.Gotham
    notif.TextSize = 14
    notif.Parent = self.MainFrame
    
    -- 添加淡入效果
    notif.BackgroundTransparency = 1
    notif.TextTransparency = 1
    notif:TweenBackgroundTransparency(0, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3)
    notif:TweenTextTransparency(0, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3)
    
    spawn(function()
        wait(3)
        -- 添加淡出效果
        notif:TweenBackgroundTransparency(1, Enum.EasingDirection.In, Enum.EasingStyle.Quad, 0.3)
        notif:TweenTextTransparency(1, Enum.EasingDirection.In, Enum.EasingStyle.Quad, 0.3, true, function()
            notif:Destroy()
        end)
    end)
end

-- 旋转角色功能
function NanzhuHelper:ToggleRotation()
    if self.isRotating then
        self.isRotating = false
        self:ShowNotification("快速旋转已关闭")
    else
        self.isRotating = true
        self:ShowNotification("快速旋转已开启 - 速度: " .. self.rotationSpeed)
        self:StartRotation()
    end
end

function NanzhuHelper:ToggleFastRotation()
    if self.isFastRotating then
        self.isFastRotating = false
        self:ShowNotification("极速旋转已关闭")
    else
        self.isFastRotating = true
        self:ShowNotification("极速旋转已开启 - 速度: " .. self.fastRotationSpeed)
        self:StartFastRotation()
    end
end

function NanzhuHelper:StartRotation()
    spawn(function()
        while self.isRotating do
            local character = game.Players.LocalPlayer.Character
            if character then
                local humanoid = character:FindFirstChildOfClass("Humanoid")
                if humanoid then
                    humanoid.AutoRotate = false
                    character:SetPrimaryPartCFrame(character.PrimaryPart.CFrame * CFrame.Angles(0, math.rad(self.rotationSpeed), 0))
                end
            end
            wait()
        end
        -- 恢复自动旋转
        local character = game.Players.LocalPlayer.Character
        if character then
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.AutoRotate = true
            end
        end
    end)
end

function NanzhuHelper:StartFastRotation()
    spawn(function()
        while self.isFastRotating do
            local character = game.Players.LocalPlayer.Character
            if character then
                local humanoid = character:FindFirstChildOfClass("Humanoid")
                if humanoid then
                    humanoid.AutoRotate = false
                    character:SetPrimaryPartCFrame(character.PrimaryPart.CFrame * CFrame.Angles(0, math.rad(self.fastRotationSpeed), 0))
                end
            end
            wait()
        end
        -- 恢复自动旋转
        local character = game.Players.LocalPlayer.Character
        if character then
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.AutoRotate = true
            end
        end
    end)
end

-- 创建主菜单
function NanzhuHelper:CreateMainMenu()
    -- 创建滚动框架
    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Name = "ScrollFrame"
    scrollFrame.Size = UDim2.new(1, -40, 1, -60)
    scrollFrame.Position = UDim2.new(0, 20, 0, 60)
    scrollFrame.BackgroundTransparency = 1
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarThickness = 5
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    scrollFrame.Parent = self.MainFrame
    
    -- 创建按钮容器
    local buttonContainer = Instance.new("Frame")
    buttonContainer.Name = "ButtonContainer"
    buttonContainer.Size = UDim2.new(1, 0, 0, 0)
    buttonContainer.BackgroundTransparency = 1
    buttonContainer.Parent = scrollFrame
    
    -- 创建布局
    local layout = Instance.new("UIListLayout")
    layout.Name = "Layout"
    layout.Padding = UDim.new(0, 10)
    layout.Parent = buttonContainer
    
    -- 更新CanvasSize
    layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        scrollFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y)
        buttonContainer.Size = UDim2.new(1, 0, 0, layout.AbsoluteContentSize.Y)
    end)
    
    -- 通用功能按钮
    local universalButton = Instance.new("TextButton")
    universalButton.Name = "UniversalButton"
    universalButton.Text = "通用功能"
    universalButton.Size = UDim2.new(1, 0, 0, 40)
    universalButton.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    universalButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    universalButton.Font = Enum.Font.Gotham
    universalButton.TextSize = 16
    universalButton.Parent = buttonContainer
    
    -- 其他功能按钮...
    local otherButton = Instance.new("TextButton")
    otherButton.Name = "OtherButton"
    otherButton.Text = "其他功能"
    otherButton.Size = UDim2.new(1, 0, 0, 40)
    otherButton.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    otherButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    otherButton.Font = Enum.Font.Gotham
    otherButton.TextSize = 16
    otherButton.Parent = buttonContainer
    
    -- 按钮点击事件
    universalButton.MouseButton1Click:Connect(function()
        self:CreateUniversalMenu(buttonContainer)
    end)
end

-- 创建通用功能菜单
function NanzhuHelper:CreateUniversalMenu(container)
    -- 清空容器
    for _, child in ipairs(container:GetChildren()) do
        if child:IsA("GuiObject") then
            child:Destroy()
        end
    end
    
    -- 返回按钮
    local backButton = Instance.new("TextButton")
    backButton.Name = "BackButton"
    backButton.Text = "← 返回"
    backButton.Size = UDim2.new(1, 0, 0, 40)
    backButton.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    backButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    backButton.Font = Enum.Font.Gotham
    backButton.TextSize = 16
    backButton.Parent = container
    
    -- 快速旋转按钮
    local rotationButton = Instance.new("TextButton")
    rotationButton.Name = "RotationButton"
    rotationButton.Text = "快速旋转 (速度50)"
    rotationButton.Size = UDim2.new(1, 0, 0, 40)
    rotationButton.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    rotationButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    rotationButton.Font = Enum.Font.Gotham
    rotationButton.TextSize = 16
    rotationButton.Parent = container
    
    -- 极速旋转按钮
    local fastRotationButton = Instance.new("TextButton")
    fastRotationButton.Name = "FastRotationButton"
    fastRotationButton.Text = "极速旋转 (速度100)"
    fastRotationButton.Size = UDim2.new(1, 0, 0, 40)
    fastRotationButton.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    fastRotationButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    fastRotationButton.Font = Enum.Font.Gotham
    fastRotationButton.TextSize = 16
    fastRotationButton.Parent = container
    
    -- 按钮事件
    backButton.MouseButton1Click:Connect(function()
        self:CreateMainMenu()
    end)
    
    rotationButton.MouseButton1Click:Connect(function()
        self:ToggleRotation()
    end)
    
    fastRotationButton.MouseButton1Click:Connect(function()
        self:ToggleFastRotation()
    end)
end

-- 启动助手
NanzhuHelper:InitUI()